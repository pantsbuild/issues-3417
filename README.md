# Bootstrapping an existing `src/go/src` layout repo with pants.

1. First seed.

    ```
$ ./seed.sh

22:41:55 00:00 [main]
               (To run a reporting server: ./pants server)
22:41:55 00:00   [setup]
22:41:55 00:00     [parse]
               Executing tasks in goals: buildgen
22:41:55 00:00   [buildgen]
22:41:55 00:00     [go].
                    3rdparty/go/github.com/gorilla/mux/BUILD (github.com/gorilla/mux) FLOATING
                    src/go/src/server/BUILD (src/server)
                   Un-pinned (FLOATING) Go remote library dependencies are not allowed in this repository!
                   Found the following FLOATING Go remote libraries:
                    3rdparty/go/github.com/gorilla/mux/BUILD (github.com/gorilla/mux) FLOATING
                   You can fix this by editing the target in each FLOATING BUILD file listed above to include a `rev` parameter that points to a sha, tag or commit id that pins the code in the source repository to a fixed, non-FLOATING version.
FAILURE: Un-pinned (FLOATING) Go remote libraries detected.


22:41:55 00:00   [complete]
               FAILURE
```

2. Pin `github.com/gorilla/mux`.

    ```diff
$ git diff
diff --git a/3rdparty/go/github.com/gorilla/mux/BUILD b/3rdparty/go/github.com/gorilla/mux/BUILD
index 5d283d4..38ed297 100644
--- a/3rdparty/go/github.com/gorilla/mux/BUILD
+++ b/3rdparty/go/github.com/gorilla/mux/BUILD
@@ -1,4 +1,4 @@
 # Auto-generated by pants!
 # To re-generate run: `pants buildgen.go --materialize --remote`

-go_remote_library()
+go_remote_library(rev='v1.1')
```

3. First try to build the binary.

    ```
$ ./pants binary ::

22:44:57 00:00 [main]
               (To run a reporting server: ./pants server)
22:44:57 00:00   [setup]
22:44:57 00:00     [parse]
               Executing tasks in goals: bootstrap -> imports -> unpack-jars -> deferred-sources -> jvm-platform-validate -> gen -> resolve -> resources -> compile -> binary
22:44:57 00:00   [bootstrap]
22:44:57 00:00     [jar-dependency-management]
22:44:57 00:00     [bootstrap-jvm-tools]
22:44:57 00:00   [imports]
22:44:57 00:00     [ivy-imports]
22:44:57 00:00   [unpack-jars]
22:44:57 00:00     [unpack-jars]
22:44:57 00:00   [deferred-sources]
22:44:57 00:00     [deferred-sources]
22:44:57 00:00   [jvm-platform-validate]
22:44:57 00:00     [jvm-platform-validate]
22:44:57 00:00   [gen]
22:44:57 00:00     [go-thrift]
22:44:57 00:00     [thrift]
22:44:57 00:00     [protoc]
22:44:57 00:00     [antlr]
22:44:57 00:00     [ragel]
22:44:57 00:00     [jaxb]
22:44:57 00:00     [wire]
22:44:57 00:00   [resolve]
22:44:57 00:00     [ivy]
22:44:57 00:00       [cache]
22:44:57 00:00       [bootstrap-nailgun-server]
22:44:57 00:00     [go]
22:44:57 00:00       [cache]
                   No cached artifacts for 1 target.
                   Invalidated 1 target.INFO] Downloading https://github.com/gorilla/mux/archive/v1.1.tar.gz...

22:45:00 00:03       [github.com/gorilla/mux]WARN] Injecting dependency from BuildFileAddress(BuildFile(3rdparty/go/github.com/gorilla/mux/BUILD, FileSystemProjectTree(/home/jsirois/dev/pantsbuild/issues-3417)), mux) on 3rdparty/go/github.com/gorilla/context:context, but the dependency is not in the BuildGraph.  This probably indicates a dependency cycle, but it is not an error until sort_targets is called on a subgraph containing the cycle.

                   3rdparty/go/github.com/gorilla/mux has remote dependencies which require local declaration:
                    --> github.com/gorilla/context (expected go_remote_library declaration at 3rdparty/go/github.com/gorilla/context)
FAILURE: Failed to resolve transitive Go remote dependencies.


               Waiting for background workers to finish.
22:45:00 00:03   [complete]
               FAILURE
```

4. Second seed.

    ```
$ mkdir -p 3rdparty/go/github.com/gorilla/context && echo  "go_remote_library()" > 3rdparty/go/github.com/gorilla/context/BUILD
$ ./seed.sh

22:45:52 00:00 [main]
               (To run a reporting server: ./pants server)
22:45:52 00:00   [setup]
22:45:52 00:00     [parse]
               Executing tasks in goals: buildgen
22:45:52 00:00   [buildgen]
22:45:52 00:00     [go].
                    3rdparty/go/github.com/gorilla/mux/BUILD (github.com/gorilla/mux) v1.1
                    3rdparty/go/github.com/gorilla/context/BUILD (github.com/gorilla/context) FLOATING
                    src/go/src/server/BUILD (src/server)
                   Un-pinned (FLOATING) Go remote library dependencies are not allowed in this repository!
                   Found the following FLOATING Go remote libraries:
                    3rdparty/go/github.com/gorilla/context/BUILD (github.com/gorilla/context) FLOATING
                   You can fix this by editing the target in each FLOATING BUILD file listed above to include a `rev` parameter that points to a sha, tag or commit id that pins the code in the source repository to a fixed, non-FLOATING version.
FAILURE: Un-pinned (FLOATING) Go remote libraries detected.


22:45:53 00:01   [complete]
               FAILURE
```

5. Pin `github.com/gorilla/context`.

    ```diff
$ git diff
diff --git a/3rdparty/go/github.com/gorilla/context/BUILD b/3rdparty/go/github.com/gorilla/context/BUILD
index 5d283d4..38ed297 100644
--- a/3rdparty/go/github.com/gorilla/context/BUILD
+++ b/3rdparty/go/github.com/gorilla/context/BUILD
@@ -1,4 +1,4 @@
 # Auto-generated by pants!
 # To re-generate run: `pants buildgen.go --materialize --remote`

-go_remote_library()
+go_remote_library(rev='v1.1')
```

6. Succeed at building the binary.

    ```
$ ./pants binary ::

22:48:21 00:00 [main]
               (To run a reporting server: ./pants server)
22:48:21 00:00   [setup]
22:48:21 00:00     [parse]
               Executing tasks in goals: bootstrap -> imports -> unpack-jars -> deferred-sources -> gen -> jvm-platform-validate -> resolve -> resources -> compile -> binary
22:48:21 00:00   [bootstrap]
22:48:21 00:00     [jar-dependency-management]
22:48:21 00:00     [bootstrap-jvm-tools]
22:48:21 00:00   [imports]
22:48:21 00:00     [ivy-imports]
22:48:21 00:00   [unpack-jars]
22:48:21 00:00     [unpack-jars]
22:48:21 00:00   [deferred-sources]
22:48:21 00:00     [deferred-sources]
22:48:21 00:00   [gen]
22:48:21 00:00     [go-thrift]
22:48:21 00:00     [thrift]
22:48:21 00:00     [protoc]
22:48:21 00:00     [antlr]
22:48:21 00:00     [ragel]
22:48:21 00:00     [jaxb]
22:48:21 00:00     [wire]
22:48:21 00:00   [jvm-platform-validate]
22:48:21 00:00     [jvm-platform-validate]
22:48:21 00:00   [resolve]
22:48:21 00:00     [ivy]
22:48:21 00:00     [go]
22:48:21 00:00       [cache]
                   No cached artifacts for 1 target.
                   Invalidated 1 target.INFO] Downloading https://github.com/gorilla/context/archive/v1.1.tar.gz...

22:48:23 00:02       [github.com/gorilla/context]
22:48:24 00:03       [github.com/gorilla/mux]
22:48:24 00:03   [resources]
22:48:24 00:03     [prepare]
22:48:24 00:03     [services]
22:48:24 00:03   [compile]
22:48:24 00:03     [compile-jvm-prep-command]
22:48:24 00:03       [jvm_prep_command]
22:48:24 00:03     [compile-prep-command]
22:48:24 00:03     [go]
22:48:24 00:03       [cache]
                   No cached artifacts for 3 targets.
                   Invalidated 3 targets.
22:48:24 00:03       [install]

22:48:24 00:03       [install]

22:48:24 00:03       [install]

22:48:25 00:04     [gofmt]
22:48:25 00:04       [cache]
                   No cached artifacts for 1 target.
                   Invalidated 1 target.
22:48:25 00:04     [compile]
22:48:25 00:04     [zinc]
22:48:25 00:04     [jvm-dep-check]
22:48:25 00:04   [binary]
22:48:25 00:04     [binary-jvm-prep-command]
22:48:25 00:04       [jvm_prep_command]
22:48:25 00:04     [binary-prep-command]
22:48:25 00:04     [go]
                   creating dist/go/bin/server
22:48:25 00:04     [python-binary-create]
22:48:25 00:04     [jvm]
22:48:25 00:04     [dup]
               Waiting for background workers to finish.
22:48:25 00:04   [complete]
               SUCCESS
$ tree dist/
dist/
└── go
    └── bin
        └── server

2 directories, 1 file
$ file dist/go/bin/server
dist/go/bin/server: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, not stripped
```
